<!DOCTYPE html>
<html>

	<head>
		<title>MelaninMedical</title>
		<link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&display=swap" rel="stylesheet">
		<link href="https://fonts.googleapis.com/css2?family=Abril+Fatface&family=Poppins:wght@200&display=swap"
			rel="stylesheet">

		<link rel="stylesheet" href="default.css" />
		<link rel="stylesheet" href="index.css" />
	</head>

	<body>
		<div class="container">
			<div class="row">
				<h1>Connect with an Advocate</h1>
				<h2>A space to find immediate support and advocacy when speaking with a medical provider.</h2>
			</div>
			<div class="row">
				<div id="local-media-container"></div>
			</div>

			<section>
				<h3><a href="/">Home page</a></h3>
				<ul class="advocate-list">
					<li class="margin-vert--lg">
						<h3>Advocate One</h3>
						<img class="advocate-avatar" src="./static/images/image1.png" />
						<p class="status-available">Available</p>
						<button id="join-button">Connect with this Advocate</button>
						<button id="leave-button" class="hidden">Leave Room</button>
						<div id="waiting-room" class="hidden">
							<p>Thanks! Your provider will be with you shortly.</p>
						</div>
					</li>
					<li class="margin-vert--lg">
						<h3>Advocate Two</h3>
						<img class="advocate-avatar" src="./static/images/image2.png" />
						<p>Unavailable</p>
						<button id="join-button">Connect with this Advocate</button>
						<button id="leave-button" class="hidden">Leave Room</button>
						<div id="waiting-room" class="hidden">
							<p>Thanks! Your provider will be with you shortly.</p>
						</div>
					</li>
					<li class="margin-vert--lg">
						<h3>Advocate Three</h3>
						<img class="advocate-avatar" src="./static/images/image3.png" />
						<p>Unavailable</p>
						<button id="join-button">Connect with this Advocate</button>
						<button id="leave-button" class="hidden">Leave Room</button>
						<div id="waiting-room" class="hidden">
							<p>Thanks! Your provider will be with you shortly.</p>
						</div>
					</li>
					<li class="margin-vert--lg">
						<h3>Advocate Four</h3>
						<img class="advocate-avatar" src="./static/images/image4.png" />
						<p>Unvailable</p>
						<button id="join-button" class="status-unavailable">Connect with this Advocate</button>
						<button id="leave-button" class="hidden">Leave Room</button>
						<div id="waiting-room" class="hidden">
							<p>Thanks! Your provider will be with you shortly.</p>
						</div>
					</li>
				</ul>
			</section>
		</div>
	</body>

	<script src="./index.js"></script>
	<script src="//media.twiliocdn.com/sdk/js/video/releases/2.3.0/twilio-video.min.js"></script>
	<script>
		const providerIdentity = "provider";

		async function onJoinButtonClick(event) {
			await joinRoom(event, "patient");

			// is there a doctor in the house??
			// if not, show the waiting room
			if (!isProviderPresent(room.participants)) {
				showWaitingRoom();
			}

			// if the provider joins, hide the waiting room
			room.on("participantConnected", (participant) => {
				if (particiant.identity === providerIdentity) {
					hideWaitingRoom();
				}
			});

			// hide the waiting room if the patient disconnects
			room.on("disconnected", () => {
				hideWaitingRoom();
			});
			event.preventDefault();
		}

		const isProviderPresent = (participantMap) => {
			for (const participant of participantMap.values()) {
				if (participant.identity === providerIdentity) {
					return true;
				}
			}
			return false;
		};

		const hideWaitingRoom = () => {
			const waitingRoom = document.getElementById("waiting-room");
			// check that the waiting room is visible, before hiding
			// just to avoid weird state bugs
			if (!waitingRoom.classList.contains("hidden")) {
				waitingRoom.classList.toggle("hidden");
				stopWaitingRoomVideo();
			}
		};

		const showWaitingRoom = () => {
			const waitingRoom = document.getElementById("waiting-room");
			// check that the waiting room is hidden, before showing
			// just to avoid weird state bugs
			if (waitingRoom.classList.contains("hidden")) {
				waitingRoom.classList.toggle("hidden");
			}
		};

		const stopWaitingRoomVideo = () => {
			const iframe = document.querySelector("iframe");
			const video = document.querySelector("video");
			if (iframe !== null) {
				const iframeSrc = iframe.src;
				iframe.src = iframeSrc;
			}
			if (video !== null) {
				video.pause();
			}
		};

		const button = document.getElementById("join-button");
		button.addEventListener("click", onJoinButtonClick);

		const leaveButton = document.getElementById("leave-button");
		leaveButton.addEventListener("click", onLeaveButtonClick);
	</script>

</html>
